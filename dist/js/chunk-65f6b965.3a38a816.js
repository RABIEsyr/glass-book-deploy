(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-65f6b965"],{"7e47":function(e,t,n){"use strict";n.r(t);var r=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"video-container"},[n("video",{staticClass:"remote-video",attrs:{autoplay:"",id:"remote-video"}}),n("div",{staticClass:"callee-name"},[e._v(e._s(e.calleName))]),n("div",{staticClass:"local-video-wrapper"},[n("video",{staticClass:"local-video",attrs:{autoplay:"",muted:"",id:"local-video"},domProps:{muted:!0}})]),n("div",{staticClass:"video-controls"},[n("button",{staticClass:"control-btn mute-btn",class:{active:e.isMuted},on:{click:e.toggleMute}},[n("v-icon",[e._v(e._s(e.isMuted?"mdi-microphone-off":"mdi-microphone"))])],1),n("button",{staticClass:"control-btn end-call-btn",on:{click:e.endCall}},[n("v-icon",[e._v("mdi-phone-hangup")])],1)])])},o=[],a=(n("4160"),n("b0c0"),n("159b"),n("3835")),c=(n("96cf"),n("1da1")),i=n("5530"),s=n("db49"),l=n("8055"),u=n.n(l),d=n("2f62"),p=window,m=p.RTCSessionDescription,f={data:function(){return{socket:u()(s["a"],{query:{token:localStorage.getItem("token")}}),calleName:"",callId:null}},computed:Object(i["a"])(Object(i["a"])({},Object(d["c"])({peerConnectionState:"getRtcPeerConnection"})),{},{callActive:function(){return this.peerConnectionState&&"closed"!==this.peerConnectionState.signalingState}}),created:function(){var e=this;return Object(c["a"])(regeneratorRuntime.mark((function t(){var n,r,o;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return e.calleName=e.$route.params.name,e.callId=e.$route.params.id,n=null,t.prev=3,t.next=6,navigator.mediaDevices.getUserMedia({video:!0,audio:!0});case 6:n=t.sent,r=document.getElementById("local-video"),r&&(r.srcObject=n),n.getTracks().forEach((function(t){return e.peerConnectionState.addTrack(t,n)})),t.next=15;break;case 12:t.prev=12,t.t0=t["catch"](3),alert(t.t0);case 15:e.peerConnectionState.ontrack=function(e){var t=Object(a["a"])(e.streams,1),n=t[0],r=document.getElementById("remote-video");r&&(r.srcObject=n)},e.socket.on("call-made",function(){var t=Object(c["a"])(regeneratorRuntime.mark((function t(n){var r;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.peerConnectionState.setRemoteDescription(new m(n.offer));case 2:return t.next=4,e.peerConnectionState.createAnswer();case 4:return r=t.sent,t.next=7,e.peerConnectionState.setLocalDescription(new m(r));case 7:e.socket.emit("make-answer",{answer:r,to:n.socket});case 8:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),e.socket.on("answer-made",function(){var t=Object(c["a"])(regeneratorRuntime.mark((function t(n){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.peerConnectionState.setRemoteDescription(new m(n.answer));case 2:e.callUser();case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),e.$route.params.caller&&(o=e,setTimeout((function(){o.callUser()}),4e3)),e.socket.on("end-call",Object(c["a"])(regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:console.log("call ended"),setTimeout((function(){e.$router.push("/call-ended")}),1500);try{e.peerConnectionState&&(n=e.peerConnectionState,n.getSenders().forEach((function(e){e.track&&e.track.stop()})),n.close(),e.$store.commit("setPeerConnection",null)),e.cleanupVideo("local-video"),e.cleanupVideo("remote-video"),e.$notify({title:"تم إنهاء المكالمة",text:"الطرف الآخر أنهى المكالمة",type:"info",duration:5e3}),setTimeout((function(){e.$router.push("/call-ended")}),1500)}catch(r){console.error("Error handling remote call end:",r)}case 3:case"end":return t.stop()}}),t)}))));case 20:case"end":return t.stop()}}),t,null,[[3,12]])})))()},methods:{callUser:function(){var e=this;return Object(c["a"])(regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.peerConnectionState.createOffer();case 2:return n=t.sent,t.next=5,e.peerConnectionState.setLocalDescription(new m(n));case 5:e.socket.emit("call-user",{offer:n,to:e.$route.params.id});case 6:case"end":return t.stop()}}),t)})))()},endCall:function(){var e=this;return Object(c["a"])(regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(t.prev=0,e.peerConnectionState&&"closed"!==e.peerConnectionState.signalingState){t.next=4;break}return console.log("No active call to end"),t.abrupt("return");case 4:n=e.peerConnectionState.getSenders(),n.forEach((function(e){e.track&&e.track.stop()})),e.peerConnectionState.close(),e.socket.emit("end-call",{to:e.$route.params.id}),console.log("the id",e.$route.params.id),e.cleanupVideo("local-video"),e.cleanupVideo("remote-video"),e.$router.push("/call-ended"),t.next=18;break;case 14:t.prev=14,t.t0=t["catch"](0),console.error("Error ending call:",t.t0),e.$notify({title:"Error",text:"Failed to end call properly",type:"error"});case 18:case"end":return t.stop()}}),t,null,[[0,14]])})))()},handleCallEnd:function(e){this.endCall(),this.$notify({title:"Call ended",text:"user-ended"===e?"Other user ended the call":"Call disconnected",type:"info"})},cleanupVideo:function(e){var t=document.getElementById(e);t&&t.srcObject&&(t.srcObject.getTracks().forEach((function(e){e.stop()})),t.srcObject=null,t.removeAttribute("srcObject"))}},beforeDestroy:function(){this.endCall(),this.socket.emit("end-call",{to:this.callId})}},v=f,h=(n("8b2e"),n("2877")),b=n("6544"),g=n.n(b),w=n("132d"),C=Object(h["a"])(v,r,o,!1,null,"e6f883f8",null);t["default"]=C.exports;g()(C,{VIcon:w["a"]})},"8b2e":function(e,t,n){"use strict";var r=n("f028"),o=n.n(r);o.a},f028:function(e,t,n){}}]);
//# sourceMappingURL=chunk-65f6b965.3a38a816.js.map