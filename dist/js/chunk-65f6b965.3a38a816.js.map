{"version":3,"sources":["webpack:///./src/components/chat/VideoCall.vue?2a0d","webpack:///src/components/chat/VideoCall.vue","webpack:///./src/components/chat/VideoCall.vue?04a5","webpack:///./src/components/chat/VideoCall.vue?c76e","webpack:///./src/components/chat/VideoCall.vue?1d97"],"names":["render","_vm","this","_h","$createElement","_c","_self","staticClass","attrs","_v","_s","calleName","domProps","class","active","isMuted","on","toggleMute","endCall","staticRenderFns","query","callActive","peerConnectionState","component","VIcon"],"mappings":"yHAAA,IAAIA,EAAS,WAAa,IAAIC,EAAIC,KAASC,EAAGF,EAAIG,eAAmBC,EAAGJ,EAAIK,MAAMD,IAAIF,EAAG,OAAOE,EAAG,MAAM,CAACE,YAAY,mBAAmB,CAACF,EAAG,QAAQ,CAACE,YAAY,eAAeC,MAAM,CAAC,SAAW,GAAG,GAAK,kBAAkBH,EAAG,MAAM,CAACE,YAAY,eAAe,CAACN,EAAIQ,GAAGR,EAAIS,GAAGT,EAAIU,cAAcN,EAAG,MAAM,CAACE,YAAY,uBAAuB,CAACF,EAAG,QAAQ,CAACE,YAAY,cAAcC,MAAM,CAAC,SAAW,GAAG,MAAQ,GAAG,GAAK,eAAeI,SAAS,CAAC,OAAQ,OAAUP,EAAG,MAAM,CAACE,YAAY,kBAAkB,CAACF,EAAG,SAAS,CAACE,YAAY,uBAAuBM,MAAM,CAACC,OAAQb,EAAIc,SAASC,GAAG,CAAC,MAAQf,EAAIgB,aAAa,CAACZ,EAAG,SAAS,CAACJ,EAAIQ,GAAGR,EAAIS,GAAGT,EAAIc,QAAU,qBAAuB,sBAAsB,GAAGV,EAAG,SAAS,CAACE,YAAY,2BAA2BS,GAAG,CAAC,MAAQf,EAAIiB,UAAU,CAACb,EAAG,SAAS,CAACJ,EAAIQ,GAAG,uBAAuB,QACzyBU,EAAkB,G,+HC8CtB,S,EAAA,sBAIA,GACE,KAAF,kBAEM,OAAN,YACQC,MAAO,CAAf,uCAEA,aACA,cAEE,SAAF,iCACA,gBACI,oBAAJ,0BAFA,IAIIC,WAJJ,WAKM,OAAOnB,KAAKoB,qBAClB,sDAIE,QAnBF,WAmBA,yKACA,iCACA,4BAEA,OAJA,kBAMA,yDANA,OAMA,EANA,OAOA,yCACA,IACA,eACA,iFAVA,qDAYA,YAZA,QAgBA,mFACA,0CACA,IACA,gBAIA,sMAEA,2DAFA,uBAGA,qCAHA,cAGA,EAHA,gBAIA,oDAJA,OAKA,6BACA,SACA,cAPA,kGAWA,kMACA,4DADA,OAGA,aAHA,kGAOA,yBACA,IACA,uBACA,eACA,MAMA,mKACA,0BACA,uBACA,gCACA,MACA,IAEA,wBACA,wBAGA,oCACA,2BAIA,UAGA,2CAIA,8BACA,+BAGA,WACA,0BACA,iCACA,YACA,eAIA,uBACA,gCACA,MAEA,SACA,mDAxCA,4CAnDA,6DA+FE,QAAF,CAII,SAJJ,WAIM,IAAN,OAAM,OAAN,4JACA,oCADA,cACA,EADA,gBAEA,oDAFA,OAGA,2BACA,QACA,wBALA,8CAQA,QAZA,WAYA,0KAGA,uEAHA,uBAIA,qCAJA,0BASA,qCACA,uBACA,SACA,kBAKA,8BAGA,0BACA,wBAEA,yCAGA,8BACA,+BAIA,8BA/BA,qDAkCA,yCACA,WACA,cACA,mCACA,eAtCA,6DA0CA,cAtDA,SAsDA,GACA,eACA,cACA,mBACA,sEACA,eAGA,aA9DA,SA8DA,GACA,iCACA,iBACA,6CACA,YAEA,iBACA,kCAKA,cA5LA,WA6LA,eACA,6BACM,GAAN,gBClPkW,I,yDCQ9VC,EAAY,eACd,EACAvB,EACAmB,GACA,EACA,KACA,WACA,MAIa,aAAAI,EAAiB,QAKhC,IAAkBA,EAAW,CAACC,QAAA,Q,oCCxB9B,yBAA0f,EAAG,G","file":"js/chunk-65f6b965.3a38a816.js","sourcesContent":["var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('div',{staticClass:\"video-container\"},[_c('video',{staticClass:\"remote-video\",attrs:{\"autoplay\":\"\",\"id\":\"remote-video\"}}),_c('div',{staticClass:\"callee-name\"},[_vm._v(_vm._s(_vm.calleName))]),_c('div',{staticClass:\"local-video-wrapper\"},[_c('video',{staticClass:\"local-video\",attrs:{\"autoplay\":\"\",\"muted\":\"\",\"id\":\"local-video\"},domProps:{\"muted\":true}})]),_c('div',{staticClass:\"video-controls\"},[_c('button',{staticClass:\"control-btn mute-btn\",class:{active: _vm.isMuted},on:{\"click\":_vm.toggleMute}},[_c('v-icon',[_vm._v(_vm._s(_vm.isMuted ? 'mdi-microphone-off' : 'mdi-microphone'))])],1),_c('button',{staticClass:\"control-btn end-call-btn\",on:{\"click\":_vm.endCall}},[_c('v-icon',[_vm._v(\"mdi-phone-hangup\")])],1)])])}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","<template>\r\n    <!-- <div class=\"video-container\">\r\n        <button @click=\"callUser()\">Call</button>\r\n           <div>\r\n            <div style=\"position: absolute; width:50px; height: 50px; z-index: 11\">\r\n               <video style=\"position: absolute; width: 250px\" autoplay class=\"local-video\" id=\"local-video\"></video>\r\n            </div>\r\n            <div style=\"position: absolute\">\r\n                <h1 style=\"position: absolute; z-index: 11; margin-left: 500px\">{{calleName}}</h1>\r\n                <video style=\"position: absolute\" autoplay muted class=\"remote-video\" id=\"remote-video\"></video>\r\n            </div>\r\n           </div>\r\n         </div> -->\r\n    <!-- الفيديو البعيد -->\r\n   <div class=\"video-container\">\r\n    <!-- الفيديو البعيد -->\r\n    <video autoplay class=\"remote-video\" id=\"remote-video\"></video>\r\n    \r\n    <!-- اسم المتصل -->\r\n    <div class=\"callee-name\">{{ calleName }}</div>\r\n    \r\n    <!-- الفيديو المحلي -->\r\n    <div class=\"local-video-wrapper\">\r\n      <video autoplay muted class=\"local-video\" id=\"local-video\"></video>\r\n    </div>\r\n    \r\n    <!-- عناصر التحكم -->\r\n    <div class=\"video-controls\">\r\n      <button class=\"control-btn mute-btn\" @click=\"toggleMute\" :class=\"{active: isMuted}\">\r\n        <v-icon>{{ isMuted ? 'mdi-microphone-off' : 'mdi-microphone' }}</v-icon>\r\n      </button>\r\n      \r\n      <button class=\"control-btn end-call-btn\" @click=\"endCall\">\r\n        <v-icon>mdi-phone-hangup</v-icon>\r\n      </button>\r\n      \r\n      <!-- <button class=\"control-btn\" @click=\"toggleVideo\">\r\n        <v-icon>{{ videoDisabled ? 'mdi-video-off' : 'mdi-video' }}</v-icon>\r\n      </button> -->\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport serverUrl from '../../config';\r\nimport io from \"socket.io-client\";\r\nimport {mapGetters} from 'vuex';\r\n const {  RTCSessionDescription } = window;\r\n//  const peerConnection = new RTCPeerConnection();\r\n\r\n//  let isAlreadyCalling = false;\r\nexport default {\r\n   data: () => ({\r\n    //    socket: io(\"http://localhost:3000\", {\r\n       socket: io(serverUrl, {\r\n        query: { token: localStorage.getItem(\"token\") },\r\n    }),\r\n    calleName: '',\r\n    callId: null\r\n   }),\r\n   computed: {\r\n       ...mapGetters({\r\n           peerConnectionState: 'getRtcPeerConnection'\r\n       }),\r\n    callActive() {\r\n      return this.peerConnectionState && \r\n             this.peerConnectionState.signalingState !== 'closed';\r\n    }\r\n  \r\n   }, \r\n   async created() {\r\n      this.calleName = this.$route.params.name;\r\n      this.callId = this.$route.params.id;\r\n      \r\n      let stream = null;\r\n      try {\r\n          stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});\r\n          const localVideo = document.getElementById('local-video');\r\n          if (localVideo)\r\n             localVideo.srcObject = stream;\r\n          stream.getTracks().forEach((track) => this.peerConnectionState.addTrack(track, stream))\r\n      } catch (error) {\r\n          alert(error)\r\n      }\r\n\r\n    \r\n        this.peerConnectionState.ontrack = function({streams: [stream]}) {\r\n           const remoteVideo = document.getElementById('remote-video');\r\n           if (remoteVideo) {\r\n                remoteVideo.srcObject = stream;\r\n           }\r\n       } \r\n       \r\n       this.socket.on('call-made', async (data) => {\r\n        //    this.setIngoingCall(true);\r\n           await this.peerConnectionState.setRemoteDescription(new RTCSessionDescription(data.offer));\r\n           const answer = await this.peerConnectionState.createAnswer();\r\n           await this.peerConnectionState.setLocalDescription(new RTCSessionDescription(answer));\r\n           this.socket.emit('make-answer', {\r\n               answer,\r\n               to: data.socket\r\n           });\r\n       })\r\n\r\n       this.socket.on('answer-made', async data => {\r\n           await this.peerConnectionState.setRemoteDescription(new RTCSessionDescription(data.answer));\r\n        //    if (!isAlreadyCalling) {\r\n                this.callUser();\r\n        //        isAlreadyCalling = true;\r\n        //    }\r\n       })\r\n       if (this.$route.params.caller) {\r\n            const self = this;\r\n            setTimeout(function() {\r\n                self.callUser();\r\n            }, 4000)\r\n        }  \r\n\r\n//    this.socket.on('end-call', (data) => {\r\n//     this.handleCallEnd(data.reason);\r\n//   });\r\nthis.socket.on('end-call', async () => {\r\n    console.log('call ended')\r\n    setTimeout(() => {\r\n      this.$router.push('/call-ended');\r\n    }, 1500);\r\n  try {\r\n    // 1. إغلاق اتصال WebRTC\r\n    if (this.peerConnectionState) {\r\n      const pc = this.peerConnectionState;\r\n      \r\n      // إيقاف جميع الـ Tracks\r\n      pc.getSenders().forEach(sender => {\r\n        if (sender.track) sender.track.stop();\r\n      });\r\n      \r\n      // إغلاق الاتصال\r\n      pc.close();\r\n      \r\n      // إعادة تعيين المتغير\r\n      this.$store.commit('setPeerConnection', null);\r\n    }\r\n\r\n    // 2. تنظيف الفيديوهات\r\n    this.cleanupVideo('local-video');\r\n    this.cleanupVideo('remote-video');\r\n\r\n    // 3. إظهار إشعار للمستخدم\r\n    this.$notify({\r\n      title: 'تم إنهاء المكالمة',\r\n      text: 'الطرف الآخر أنهى المكالمة',\r\n      type: 'info',\r\n      duration: 5000\r\n    });\r\n\r\n    // 4. التوجيه إلى شاشة ما بعد المكالمة\r\n    setTimeout(() => {\r\n      this.$router.push('/call-ended');\r\n    }, 1500);\r\n\r\n  } catch (error) {\r\n    console.error('Error handling remote call end:', error);\r\n  }\r\n});\r\n   },\r\n   methods: {\r\n    //    ...mapMutations({\r\n    //        setIngoingCall: 'IngoingCall'\r\n    //    }),\r\n       async callUser() {\r\n           const offer = await this.peerConnectionState.createOffer();\r\n           await this.peerConnectionState.setLocalDescription(new RTCSessionDescription(offer));\r\n           this.socket.emit('call-user', {\r\n               offer,\r\n               to: this.$route.params.id\r\n           })\r\n       },\r\nasync endCall() {\r\n   try {\r\n    // 1. التحقق من وجود اتصال نشط\r\n    if (!this.peerConnectionState || this.peerConnectionState.signalingState === 'closed') {\r\n      console.log('No active call to end');\r\n      return;\r\n    }\r\n\r\n    // 2. إيقاف جميع tracks (الطريقة الصحيحة)\r\n    const senders = this.peerConnectionState.getSenders();\r\n    senders.forEach(sender => {\r\n      if (sender.track) {\r\n        sender.track.stop();\r\n      }\r\n    });\r\n\r\n    // 3. إغلاق الاتصال\r\n    this.peerConnectionState.close();\r\n    \r\n    // 4. إرسال إشعار إنهاء المكالمة\r\n      this.socket.emit('end-call', {\r\n        to: this.$route.params.id\r\n      });\r\n      console.log('the id', this.$route.params.id)\r\n\r\n    // 5. تنظيف الفيديوهات\r\n    this.cleanupVideo('local-video');\r\n    this.cleanupVideo('remote-video');\r\n\r\n    // 6. إعادة تعيين الحالة\r\n    \r\n     this.$router.push('/call-ended'); // توجيه لصفحة التأكيد\r\n\r\n  } catch (error) {\r\n    console.error('Error ending call:', error);\r\n    this.$notify({\r\n      title: 'Error',\r\n      text: 'Failed to end call properly',\r\n      type: 'error'\r\n    });\r\n  }\r\n  },\r\n   handleCallEnd(reason) {\r\n    this.endCall();\r\n    this.$notify({\r\n      title: 'Call ended',\r\n      text: reason === 'user-ended' ? 'Other user ended the call' : 'Call disconnected',\r\n      type: 'info'\r\n    });\r\n  },\r\n  cleanupVideo(elementId) {\r\n    const videoElement = document.getElementById(elementId);\r\n    if (videoElement && videoElement.srcObject) {\r\n      videoElement.srcObject.getTracks().forEach(track => {\r\n        track.stop(); // إيقاف كل Track\r\n      });\r\n      videoElement.srcObject = null;\r\n      videoElement.removeAttribute('srcObject');\r\n    }\r\n  }\r\n  \r\n   },\r\n beforeDestroy() {\r\n  this.endCall();\r\n  this.socket.emit('end-call', {\r\n        to: this.callId\r\n      });\r\n}\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n/* التنسيق العام للعناصر */\r\n.video-container {\r\n  position: relative;\r\n  width: 100%;\r\n  height: 100vh;\r\n  background: #000;\r\n  overflow: hidden;\r\n}\r\n\r\n/* فيديو الطرف الآخر */\r\n.remote-video {\r\n  width: 100%;\r\n  height: 100%;\r\n  object-fit: cover;\r\n}\r\n\r\n/* الفيديو المحلي المصغر */\r\n.local-video-wrapper {\r\n  position: absolute;\r\n  bottom: 20px;\r\n  right: 20px;\r\n  width: 180px;\r\n  height: 135px;\r\n  border: 3px solid #42b983;\r\n  border-radius: 12px;\r\n  box-shadow: 0 4px 15px rgba(0,0,0,0.3);\r\n  z-index: 100;\r\n  transition: all 0.3s ease;\r\n}\r\n\r\n.local-video-wrapper:hover {\r\n  transform: scale(1.05);\r\n}\r\n\r\n.local-video {\r\n  width: 100%;\r\n  height: 100%;\r\n  object-fit: cover;\r\n  border-radius: 8px;\r\n}\r\n\r\n/* شريط التحكم الرئيسي */\r\n.video-controls {\r\n  position: fixed;\r\n  bottom: 30px;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  display: flex;\r\n  gap: 15px;\r\n  background: rgba(15, 15, 15, 0.7);\r\n  backdrop-filter: blur(10px);\r\n  padding: 12px 25px;\r\n  border-radius: 50px;\r\n  box-shadow: 0 8px 25px rgba(0,0,0,0.2);\r\n  z-index: 1000;\r\n  border: 1px solid rgba(255,255,255,0.1);\r\n}\r\n\r\n/* أزرار التحكم العامة */\r\n.control-btn {\r\n  width: 50px;\r\n  height: 50px;\r\n  border-radius: 50%;\r\n  border: none;\r\n  background: rgba(255,255,255,0.1);\r\n  color: white;\r\n  cursor: pointer;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  transition: all 0.2s ease;\r\n}\r\n\r\n.control-btn:hover {\r\n  background: rgba(255,255,255,0.2);\r\n  transform: scale(1.1);\r\n}\r\n\r\n.control-btn:active {\r\n  transform: scale(0.95);\r\n}\r\n\r\n/* زر إنهاء المكالمة */\r\n.end-call-btn {\r\n  background: #ff4444;\r\n  width: 60px;\r\n  height: 60px;\r\n}\r\n\r\n.end-call-btn:hover {\r\n  background: #ff3333;\r\n  box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);\r\n}\r\n\r\n/* زر كتم الصوت */\r\n.mute-btn {\r\n  background: rgba(255,255,255,0.15);\r\n}\r\n\r\n.mute-btn.active {\r\n  background: #f44336;\r\n}\r\n\r\n/* تأثيرات أيقونات المواد */\r\n.v-icon {\r\n  font-size: 28px;\r\n  transition: all 0.2s ease;\r\n}\r\n\r\n/* اسم المتصل */\r\n.callee-name {\r\n  position: absolute;\r\n  top: 20px;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  background: rgba(0,0,0,0.6);\r\n  color: white;\r\n  padding: 8px 20px;\r\n  border-radius: 20px;\r\n  font-size: 1.2rem;\r\n  z-index: 100;\r\n  backdrop-filter: blur(5px);\r\n}\r\n\r\n/* رسالة نهاية المكالمة */\r\n.call-ended-message {\r\n  position: fixed;\r\n  top: 50%;\r\n  left: 50%;\r\n  transform: translate(-50%, -50%);\r\n  background: rgba(0,0,0,0.8);\r\n  color: white;\r\n  padding: 25px 40px;\r\n  border-radius: 15px;\r\n  z-index: 1100;\r\n  text-align: center;\r\n  max-width: 80%;\r\n  backdrop-filter: blur(10px);\r\n  border: 1px solid rgba(255,255,255,0.1);\r\n}\r\n\r\n/* للهواتف المحمولة */\r\n@media (max-width: 768px) {\r\n  .local-video-wrapper {\r\n    width: 120px;\r\n    height: 90px;\r\n    bottom: 15px;\r\n    right: 15px;\r\n  }\r\n  \r\n  .video-controls {\r\n    bottom: 20px;\r\n    padding: 10px 15px;\r\n    gap: 10px;\r\n  }\r\n  \r\n  .control-btn {\r\n    width: 45px;\r\n    height: 45px;\r\n  }\r\n  \r\n  .end-call-btn {\r\n    width: 50px;\r\n    height: 50px;\r\n  }\r\n  \r\n  .v-icon {\r\n    font-size: 24px;\r\n  }\r\n}\r\n</style>","import mod from \"-!../../../node_modules/cache-loader/dist/cjs.js??ref--12-0!../../../node_modules/thread-loader/dist/cjs.js!../../../node_modules/babel-loader/lib/index.js!../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./VideoCall.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../node_modules/cache-loader/dist/cjs.js??ref--12-0!../../../node_modules/thread-loader/dist/cjs.js!../../../node_modules/babel-loader/lib/index.js!../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./VideoCall.vue?vue&type=script&lang=js&\"","import { render, staticRenderFns } from \"./VideoCall.vue?vue&type=template&id=e6f883f8&scoped=true&\"\nimport script from \"./VideoCall.vue?vue&type=script&lang=js&\"\nexport * from \"./VideoCall.vue?vue&type=script&lang=js&\"\nimport style0 from \"./VideoCall.vue?vue&type=style&index=0&id=e6f883f8&scoped=true&lang=css&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../node_modules/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  \"e6f883f8\",\n  null\n  \n)\n\nexport default component.exports\n\n/* vuetify-loader */\nimport installComponents from \"!../../../node_modules/vuetify-loader/lib/runtime/installComponents.js\"\nimport { VIcon } from 'vuetify/lib/components/VIcon';\ninstallComponents(component, {VIcon})\n","import mod from \"-!../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--6-oneOf-1-0!../../../node_modules/css-loader/dist/cjs.js??ref--6-oneOf-1-1!../../../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../../../node_modules/postcss-loader/src/index.js??ref--6-oneOf-1-2!../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./VideoCall.vue?vue&type=style&index=0&id=e6f883f8&scoped=true&lang=css&\"; export default mod; export * from \"-!../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--6-oneOf-1-0!../../../node_modules/css-loader/dist/cjs.js??ref--6-oneOf-1-1!../../../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../../../node_modules/postcss-loader/src/index.js??ref--6-oneOf-1-2!../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./VideoCall.vue?vue&type=style&index=0&id=e6f883f8&scoped=true&lang=css&\""],"sourceRoot":""}